import pandas as pd
import os
from pathlib import Path

PROJECT_ROOT = Path(__file__).parent.parent.parent
RAW_DATA_DIR = PROJECT_ROOT / "data" / "raw_data"
CLEAN_DATA_DIR = PROJECT_ROOT / "data" / "clear_data"

def is_file_already_cleaned(raw_file_path):
    """
    Проверяет, был ли уже очищен файл
    """
    raw_filename = Path(raw_file_path).name
    cleaned_file_path = CLEAN_DATA_DIR / f"cleaned_{raw_filename}"

    if cleaned_file_path.exists():
        raw_mtime = Path(raw_file_path).stat().st_mtime
        clean_mtime = cleaned_file_path.stat().st_mtime

        if clean_mtime > raw_mtime:
            print(f"Файл уже очищен: {cleaned_file_path.name}")
            return True

    return False
def clean_wb_data(input_file, output_file=None):
    """
    Очищает данные Wildberries: удаляет ненужные категории и строки с NaN
    """
    light_industry_categories = {
        'аксессуары для животных', 'анораки', 'балаклавы', 'балетки', 'банданы', 'банты',
        'бейсболки', 'бейсболки для малышей', 'береты', 'бермуды', 'блузки', 'блузки для малышей',
        'блузки-боди', 'боди', 'боди для малышей', 'болеро', 'бомберы', 'бомберы для малышей',
        'бордшорты', 'босоножки', 'ботильоны', 'ботинки', 'ботфорты', 'браслеты', 'брелоки',
        'бриджи', 'бриджи спортивные', 'броши', 'брюки', 'брюки для малышей', 'брюки рабочие',
        'брюки спортивные', 'бусы', 'бюстгальтеры', 'бюстье', 'варежки', 'варежки для малышей',
        'варежки спортивные', 'велосипедки', 'велосипедки для малышей', 'велошорты', 'ветровки',
        'ветровки для малышей', 'визитницы', 'водолазки', 'водолазки для малышей', 'воротники',
        'галстуки', 'гетры', 'гольфы', 'гольфы для малышей', 'грации', 'джеггинсы', 'джемперы',
        'джемперы для малышей', 'джинсы', 'джинсы для малышей', 'дождевики для малышей', 'дубленки',
        'дутики', 'жакеты', 'жакеты для малышей', 'жилеты', 'жилеты для малышей', 'зажимы',
        'заколки клик-клак', 'заколки-автомат', 'заколки-бананы', 'заплатки', 'зеркальца', 'значки',
        'зонты', 'игрушки для животных', 'имиджевые очки', 'капоры', 'капоры для малышей', 'капри',
        'капри спортивные', 'кардиганы', 'кардиганы для малышей', 'карнавальные аксессуары',
        'карнавальные головные уборы', 'карнавальные маски', 'карнавальные ободки', 'карнавальные очки',
        'кеды', 'кейпы', 'кепи', 'кепи для малышей', 'клатчи', 'ключницы', 'козырьки', 'коконы для новорожденных',
        'колготки', 'колготки для малышей', 'колье', 'кольца', 'комбидресс', 'комбинезоны', 'комбинезоны для малышей',
        'комбинезоны нательные для малышей', 'комбинезоны спортивные', 'комплекты белья', 'комплекты белья для малышей',
        'комплекты нательные для малышей', 'комплекты украшений', 'компрессионные брюки', 'компрессионные колготки',
        'компрессионные носки', 'конверты для малышей', 'корсеты', 'косметички', 'костюмы', 'костюмы для животных',
        'костюмы для малышей', 'костюмы купальные', 'костюмы спортивные', 'косухи', 'кофты', 'кофты спортивные',
        'кошельки', 'крабы', 'кредитницы', 'кроссовки', 'куртки', 'куртки для малышей', 'куртки спортивные',
        'леггинсы', 'леггинсы для малышей', 'лифы для купальника', 'лонгсливы', 'лонгсливы для малышей',
        'лонгсливы спортивные', 'лоферы', 'майки бельевые', 'майки спортивные', 'майки спортивные для малышей',
        'манишки', 'маски для сна', 'маски спортивные', 'маски тканевые косметические', 'мешки для обуви',
        'митенки', 'мокасины', 'наборы аксессуаров для волос', 'наволочки', 'наволочки декоративные', 'наматрасники',
        'наушники утепленные', 'невидимки', 'носки', 'носки для малышей', 'носки ортопедические', 'ночные сорочки',
        'обложки', 'ободки', 'одеяла', 'одеяла для малышей', 'ошейники', 'пальто', 'пальто для малышей', 'панамы',
        'панамы для малышей', 'парео', 'парки', 'пеналы', 'пеньюары', 'переноски для детей', 'перчатки',
        'перчатки для малышей', 'перчатки сноубордические', 'пиджаки', 'пиджаки для малышей', 'пижамы',
        'пижамы для малышей', 'пирсинг', 'плавки', 'платки', 'платья', 'платья для малышей', 'платья спортивные',
        'платья эротик', 'плащи', 'плащи для малышей', 'пледы', 'пледы для малышей', 'плейсматы', 'повязки для волос',
        'повязки на голову', 'повязки на голову для малышей', 'подследники', 'подтяжки', 'подушки',
        'подушки декоративные',
        'подушки для малышей', 'подушки для путешествий', 'подушки на стул', 'подушки ортопедические', 'покрывала',
        'полуботинки', 'полукомбинезоны', 'полупальто', 'полусапожки', 'пончо', 'портупеи', 'портфели',
        'постельное белье',
        'пояса', 'простыни', 'пуловеры', 'пуховики', 'раздельные купальники', 'раздельные купальники для малышей',
        'расчески', 'резинки', 'резиновые сапоги', 'ремни', 'ремни для сумок', 'ролики для одежды', 'рубашки',
        'рубашки для малышей', 'рубашки спортивные', 'рюкзаки', 'сабо', 'сандалии', 'сапоги', 'сарафаны',
        'сарафаны для малышей', 'свитеры', 'свитеры для малышей', 'свитшоты', 'свитшоты для малышей',
        'свитшоты спортивные',
        'серьги', 'слипоны', 'слитные купальники', 'слитные купальники для малышей', 'снуды', 'солнцезащитные очки',
        'софы', 'стразы', 'сумки', 'сумки для ноутбуков', 'сумки спортивные', 'сумки хозяйственные', 'тайтсы',
        'тапочки',
        'твинсеты', 'термоводолазки', 'термоколготки', 'термокомплекты', 'термокомплекты спортивные', 'термолонгсливы',
        'термоноски', 'термотрусы для малышей', 'термофутболки', 'термофутболки спортивные', 'термошорты', 'толстовки',
        'толстовки для животных', 'толстовки для малышей', 'толстовки спортивные', 'топы', 'топы для малышей',
        'топы спортивные', 'топы-бра', 'тренчкоты', 'трусы', 'трусы для малышей', 'туники', 'туфли', 'тюль', 'угги',
        'украшения для обуви', 'фуражки', 'футболки', 'футболки для животных', 'футболки для малышей',
        'футболки спортивные',
        'футболки-поло', 'футболки-поло для малышей', 'футляры для очков', 'халаты домашние', 'худи',
        'худи для малышей',
        'худи спортивные', 'цепочки', 'цепочки для очков', 'цепочки на тело', 'чепчики', 'чехлы для матрасов',
        'чехлы для наушников', 'чехлы-кармашки для телефонов', 'чокеры', 'чулки', 'шапки', 'шапки для малышей',
        'шапки-ушанки', 'шапки-ушанки для малышей', 'шапки-шлемы', 'шапки-шлемы для малышей', 'шарфы', 'шлепанцы',
        'шляпы', 'шнурки', 'шнурки для кулонов', 'шнурки для телефонов', 'шорты', 'шорты для малышей',
        'шорты спортивные',
        'шубы искусственные', 'эспадрильи', 'юбки', 'юбки для малышей', 'юбки спортивные', 'ювелирные заколки',
        'юблирные запонки'
    }

    try:
        if is_file_already_cleaned(input_file):
            print(f"Пропускаем уже очищенный файл: {Path(input_file).name}")
            return None

        df = pd.read_csv(input_file)

        print(f"Обработка файла: {input_file}")
        print(f"Исходное количество строк: {len(df):,}")

        # Удаление строк с NaN значениями
        df_clean = df.dropna()

        # Фильтрация по нужным категориям
        df_filtered = df_clean[df_clean['entity'].isin(light_industry_categories)]

        # Расчет статистики
        removed_count = len(df_clean) - len(df_filtered)

        print(f"Удалено строк: {removed_count:,}")
        print(f"Осталось строк: {len(df_filtered):,}")

        if output_file is None:
            input_filename = Path(input_file).name
            # Файлы сохраняются в WB_parser/data/clear_data/
            output_file = CLEAN_DATA_DIR / f"cleaned_{input_filename}"

        df_filtered.to_csv(output_file, index=False)
        print(f"Очищенные данные сохранены в: {output_file}")

        return df_filtered

    except FileNotFoundError:
        print(f"Файл {input_file} не найден!")
        return None
def main():
    """
     Обрабатывает все CSV файлы в папке raw_data
     """

    print(f"Исходные данные: {RAW_DATA_DIR}")
    print(f"Выходные данные: {CLEAN_DATA_DIR}")

    csv_files = list(RAW_DATA_DIR.glob("*.csv"))

    for csv_file in csv_files:
        print(f"\nОбрабатываю: {csv_file.name}")
        clean_wb_data(str(csv_file))

if __name__ == "__main__":
    main()